<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>設備編集</title>
    <style>
        :root {
            --primary-color: #1976d2;
            --primary-light: #e3f2fd;
            --primary-dark: #0d47a1;
            --success-color: #4CAF50;
            --success-light: #e8f5e9;
            --success-dark: #2E7D32;
            --danger-color: #f44336;
            --danger-light: #ffebee;
            --danger-dark: #c62828;
            --warning-color: #ff9800;
            --gray-light: #f5f5f5;
            --gray-medium: #e0e0e0;
            --gray-dark: #757575;
            --text-primary: #212121;
            --text-secondary: #757575;
            --white: #ffffff;
            --shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            --border-radius: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', 'Hiragino Kaku Gothic ProN', 'メイリオ', sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background-color: #f8f9fa;
            padding: 20px;
            font-size: 16px;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 24px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 24px;
            color: var(--primary-dark);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
        }

        form {
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray-medium);
            border-radius: var(--border-radius);
            font-size: 16px;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }

        textarea {
            height: 100px;
            resize: vertical;
        }

        .date-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-group select {
            width: auto;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--gray-medium);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background-color: var(--gray-dark);
            color: var(--white);
        }

        .required {
            color: var(--danger-color);
            margin-left: 5px;
        }

        .help-text {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 16px;
            }

            .date-group {
                flex-wrap: wrap;
            }

            .button-group {
                flex-direction: column;
                gap: 10px;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>設備編集</h1>
        
        <form th:action="@{/equipment/update}" method="post" th:object="${equipmentForm}">
            <input type="hidden" th:field="*{id}" />
            
            <!-- 管理番号 -->
            <div class="form-group">
                <label for="managementNumber">管理番号<span class="required">*</span></label>
                <input type="text" id="managementNumber" th:field="*{managementNumber}" required>
            </div>
            
            <!-- カテゴリー選択 -->
            <div class="form-group">
                <label for="categoryCode">メインカテゴリー<span class="required">*</span></label>
                <select id="categoryCode" name="categoryCode" required onchange="updateSubcategories()">
                    <option value="" disabled>選択してください</option>
                    <option th:each="category : ${categories}" 
                            th:value="${category.id}" 
                            th:text="${category.name}"
                            th:selected="${category.id == equipmentForm.subcategoryId}"></option>
                </select>
            </div>
            
            <!-- サブカテゴリー選択 -->
            <div class="form-group">
                <label for="subcategoryId">サブカテゴリー<span class="required">*</span></label>
                <select id="subcategoryId" name="subcategoryId" required>
                    <option value="" selected disabled>カテゴリーを先に選択してください</option>
                </select>
            </div>
            
            <!-- 品名 -->
            <div class="form-group">
                <label for="name">品名<span class="required">*</span></label>
                <input type="text" id="name" th:field="*{name}" required>
            </div>
            
            <!-- 型番 -->
            <div class="form-group">
                <label for="modelNumber">型番</label>
                <input type="text" id="modelNumber" th:field="*{modelNumber}">
            </div>
            
            <!-- メーカー -->
            <div class="form-group">
                <label for="manufacturer">メーカー</label>
                <input type="text" id="manufacturer" th:field="*{manufacturer}">
            </div>
            
            <!-- 仕様 -->
            <div class="form-group">
                <label for="specification">仕様</label>
                <textarea id="specification" th:field="*{specification}"></textarea>
                <p class="help-text">複数行入力可能です。詳細な仕様を記載してください。</p>
            </div>
            
            <!-- 購入価格 -->
            <div class="form-group">
                <label for="cost">購入価格</label>
                <input type="number" id="cost" th:field="*{cost}" step="0.01">
                <p class="help-text">単位: 円（小数点以下2桁まで入力可能）</p>
            </div>
            
            <!-- 購入日 -->
            <div class="form-group">
                <label>購入日<span class="required">*</span></label>
                <div class="date-group">
                    <select id="purchaseYear" name="purchaseYear" required>
                        <option value="" disabled>年</option>
                        <option th:each="year : ${#numbers.sequence(2000, 2030)}" th:value="${year}" th:text="${year}"></option>
                    </select>
                    <span>年</span>
                    <select id="purchaseMonth" name="purchaseMonth" required>
                        <option value="" disabled>月</option>
                        <option th:each="month : ${#numbers.sequence(1, 12)}" th:value="${month}" th:text="${month}"></option>
                    </select>
                    <span>月</span>
                    <select id="purchaseDay" name="purchaseDay" required>
                        <option value="" disabled>日</option>
                        <option th:each="day : ${#numbers.sequence(1, 31)}" th:value="${day}" th:text="${day}"></option>
                    </select>
                    <span>日</span>
                </div>
            </div>
            
            <!-- 数量 -->
            <div class="form-group">
                <label for="quantity">数量<span class="required">*</span></label>
                <input type="number" id="quantity" th:field="*{quantity}" value="1" min="1" required>
            </div>
            
            <!-- 設置場所 -->
            <div class="form-group">
                <label for="locationCode">設置場所<span class="required">*</span></label>
                <select id="locationCode" th:field="*{locationCode}" required>
                    <option value="" disabled>選択してください</option>
                    <option th:each="loc : ${locationOptions}" th:value="${loc}"
                            th:text="${@locationRepository.findById(T(java.lang.Integer).parseInt(loc)).orElse(new com.example.equipmentmanagement.entity.Location()).getName()}"></option>
                </select>
            </div>
            
            <!-- 耐用年数の表示を削除 -->
            
            <!-- 使用期限 -->
            <div class="form-group">
                <label>使用期限（オプション）</label>
                <div class="date-group">
                    <select id="usageDeadlineYear" name="usageDeadlineYear">
                        <option value="">年</option>
                        <option th:each="year : ${#numbers.sequence(2000, 2050)}" th:value="${year}" th:text="${year}"></option>
                    </select>
                    <span>年</span>
                    <select id="usageDeadlineMonth" name="usageDeadlineMonth">
                        <option value="">月</option>
                        <option th:each="month : ${#numbers.sequence(1, 12)}" th:value="${month}" th:text="${month}"></option>
                    </select>
                    <span>月</span>
                    <select id="usageDeadlineDay" name="usageDeadlineDay">
                        <option value="">日</option>
                        <option th:each="day : ${#numbers.sequence(1, 31)}" th:value="${day}" th:text="${day}"></option>
                    </select>
                    <span>日</span>
                </div>
                <p class="help-text">使用期限が設定されている場合に入力してください。</p>
            </div>
            
            <!-- 使用不能フラグ -->
            <div class="checkbox-group">
                <input type="checkbox" id="isBroken" th:field="*{isBroken}">
                <label for="isBroken">使用不能（故障中）</label>
            </div>
            
            <!-- 貸出可能フラグ -->
            <div class="checkbox-group">
                <input type="checkbox" id="isAvailableForLoan" th:field="*{isAvailableForLoan}">
                <label for="isAvailableForLoan">貸出可能</label>
            </div>
            
            <!-- ボタングループ -->
            <div class="button-group">
                <a th:href="@{/equipment/list}">
                    <button type="button" class="btn btn-secondary">キャンセル</button>
                </a>
                <button type="submit" class="btn btn-primary">更新</button>
            </div>
        </form>
    </div>

    <script th:inline="javascript">
        // カテゴリーとサブカテゴリーのマッピング
        const categorySubcategoryMap = /*[[${categoryItemMap}]]*/ {};
        const currentCategoryId = /*[[${equipmentForm.subcategoryId != null ? 
            @subcategoryRepository.findById(equipmentForm.subcategoryId).orElse(new com.example.equipmentmanagement.entity.Subcategory()).getCategoryId() : null}]]*/ null;
        const currentSubcategoryId = /*[[${equipmentForm.subcategoryId}]]*/ null;
        const currentPurchaseDate = /*[[${equipmentForm.purchaseDate}]]*/ null;
        const currentUsageDeadline = /*[[${equipmentForm.usageDeadline}]]*/ null;

        // 購入日の設定
        const purchaseYearInput = document.getElementById('purchaseYear');
        const purchaseMonthInput = document.getElementById('purchaseMonth');
        const purchaseDayInput = document.getElementById('purchaseDay');

        // 使用期限の設定
        const usageDeadlineYearInput = document.getElementById('usageDeadlineYear');
        const usageDeadlineMonthInput = document.getElementById('usageDeadlineMonth');
        const usageDeadlineDayInput = document.getElementById('usageDeadlineDay');
        
        // サブカテゴリーの選択肢を更新する関数
        function updateSubcategories() {
            const categorySelect = document.getElementById('categoryCode');
            const subcategorySelect = document.getElementById('subcategoryId');
            const selectedCategoryId = categorySelect.value;
            
            // サブカテゴリーの選択肢をクリア
            subcategorySelect.innerHTML = '';
            
            // デフォルトのオプションを追加
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.text = '選択してください';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            subcategorySelect.appendChild(defaultOption);
            
            // 選択されたカテゴリーに対応するサブカテゴリーを追加
            if (selectedCategoryId) {
                // サーバーから取得したサブカテゴリーの情報を使用
                fetch(`/equipment/api/subcategories/${selectedCategoryId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(subcategory => {
                            const option = document.createElement('option');
                            option.value = subcategory.id;
                            option.text = subcategory.name;
                            if (currentSubcategoryId == subcategory.id) {
                                option.selected = true;
                            }
                            subcategorySelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('サブカテゴリーの取得に失敗しました:', error));
            }
        }

        // 日付文字列をパースして年月日の個別入力に設定する関数
        function setParsedDate(dateString, yearInput, monthInput, dayInput) {
            if (dateString) {
                const date = new Date(dateString);
                yearInput.value = date.getFullYear();
                monthInput.value = date.getMonth() + 1;
                dayInput.value = date.getDate();
            }
        }

        // ページロード時の初期化
        window.addEventListener('load', () => {
            // カテゴリーを設定
            if (currentCategoryId) {
                const categorySelect = document.getElementById('categoryCode');
                categorySelect.value = currentCategoryId;
                updateSubcategories();
            }

            // 購入日を年月日の個別入力に設定
            setParsedDate(currentPurchaseDate, purchaseYearInput, purchaseMonthInput, purchaseDayInput);

            // 使用期限を年月日の個別入力に設定
            setParsedDate(currentUsageDeadline, usageDeadlineYearInput, usageDeadlineMonthInput, usageDeadlineDayInput);
        });

        // カテゴリー変更時にサブカテゴリーを更新
        document.getElementById('categoryCode').addEventListener('change', updateSubcategories);
    </script>
</body>
</html>