===============================================
       設備管理システム 取扱説明書
===============================================

【システム概要】
本システムは、企業や組織の設備・備品を管理し、減価償却計算を自動化するWebアプリケーションです。
Spring Bootフレームワークを使用して開発されており、ブラウザから簡単に操作できます。
最新のリファクタリングにより、コードの可読性と保守性が向上しました。

【主な機能】
1. 設備の登録・編集・削除
2. 設備一覧の表示（並び替え機能付き）
3. 設備検索機能（設置場所、品名による検索）
4. 減価償却計算の自動実行と表示
5. 設備の設置場所管理
6. 複数設備の一括削除
7. 管理番号の自動生成

【システム要件】
- Java 21以上
- MySQL 8.0以上（またはH2 Database）
- Webブラウザ（Chrome、Firefox、Safari、Edge等）
- インターネット接続（初回セットアップ時）

【起動方法】
1. コマンドプロンプトまたはターミナルを開く
2. プロジェクトルートディレクトリに移動
3. 以下のコマンドを実行：
   Windows: mvnw.cmd spring-boot:run
   Mac/Linux: ./mvnw spring-boot:run
4. ブラウザで http://localhost:8080 にアクセス（初期画面は検索画面）

【データベース設定】
設定ファイル：src/main/resources/application.properties

MySQL使用時の設定例：
spring.datasource.url=jdbc:mysql://localhost:3306/equipmentdb?useSSL=false&serverTimezone=Asia/Tokyo
spring.datasource.username=teamkaihatsu
spring.datasource.password=（パスワードを設定）
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

H2 Database使用時（開発・テスト用）：
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driver-class-name=org.h2.Driver

【操作手順】

■ 1. 設備一覧画面
URL: /equipment/list

機能：
- 登録されている全設備の一覧を表示
- 減価償却計算結果（年間償却額、帳簿価額等）を自動表示
- 設置場所の変更（プルダウンから即時更新）
- 個別削除、編集への遷移
- 複数削除モードへの遷移

表示項目：
- 管理番号（自動生成）
- カテゴリー・品目
- 設備名
- 型番、メーカー、仕様
- 購入価格、購入日
- 数量、設置場所
- 耐用年数、経過年数
- 年間減価償却額、帳簿価額
- 減価償却状況
- 使用期限
- 故障状態、貸出可能状態

操作方法：
- 「新規登録」ボタン：設備登録画面へ移動
- 「編集」ボタン：該当設備の編集画面へ移動
- 「削除」ボタン：該当設備を削除（確認ダイアログ表示）
- 「複数削除」ボタン：複数削除モード画面へ移動
- 設置場所プルダウン：選択と同時に設置場所を更新

■ 2. 設備登録画面
URL: /equipment/create-form

機能：
- 新しい設備の登録
- カテゴリー選択時の品目自動更新（Ajax）
- 管理番号の自動生成（カテゴリーコードと年に基づく最適化されたアルゴリズム）

入力項目：
- カテゴリーコード（プルダウン）
- 品目コード（カテゴリー選択後に自動更新）
- 設備名（必須）
- 型番
- メーカー
- 仕様
- 購入価格（必須）
- 購入日（年月日を個別選択）
- 数量（デフォルト1）
- 設置場所（プルダウン）
- 使用期限（任意、年月日を個別選択、無効な日付は自動検出）
- 故障状態（チェックボックス）
- 貸出可能状態（チェックボックス）

操作方法：
1. カテゴリーをプルダウンから選択
2. 品目が自動で更新されるので選択
3. 各項目を入力
4. 「登録」ボタンで保存
5. 「キャンセル」ボタンで一覧に戻る

■ 3. 設備編集画面
URL: /equipment/edit?id=設備ID

機能：
- 既存設備の情報更新
- 入力項目は登録画面と同様
- 最適化されたデータ処理による高速な表示と更新

操作方法：
1. 設備一覧から「編集」ボタンをクリック
2. 表示された情報を編集
3. 「更新」ボタンで保存
4. 「キャンセル」ボタンで一覧に戻る

■ 4. 設備検索画面
URL: /equipment/search

機能：
- 設置場所と品名による設備検索
- 検索結果の一覧表示
- 最適化されたクエリによる高速検索

検索条件：
- 設置場所（プルダウン、「未選択」オプション有り）
- 品名（部分一致検索）

操作方法：
1. 設置場所をプルダウンから選択（任意）
2. 品名を入力（任意、部分一致）
3. 「検索」ボタンをクリック
4. 検索結果から設備を選択（ラジオボタン）
5. 「編集」「削除」ボタンで選択した設備を操作

■ 5. 複数削除画面
URL: /equipment/delete-mode

機能：
- 複数の設備を選択して一括削除
- 設備一覧と同様の表示形式

操作方法：
1. 削除したい設備のチェックボックスを選択
2. 「選択した設備を削除」ボタンをクリック
3. 確認ダイアログで「OK」を選択
4. 「一覧に戻る」ボタンで通常一覧に戻る

【減価償却計算について】

■ 計算方式：定額法
年間減価償却額 = 取得価額 ÷ 耐用年数

■ 耐用年数の決定
システムに登録されている「設備寿命マスタ」から、
カテゴリーコードと品目コードに基づいて自動取得されます。

■ 計算例
- 取得価額：100,000円
- 耐用年数：4年
- 年間減価償却額：25,000円
- 3年経過後の帳簿価額：25,000円

■ 表示項目の説明
- 経過年数：購入日から現在日までの年数（最適化された計算方法）
- 年間減価償却額：定額法による年間償却額
- 帳簿価額：取得価額 - 累積減価償却額
- 減価償却状況：「継続中」「終了」等のステータス

【設置場所について】
設置場所はデータベースの「location」テーブルから動的に取得されます。
最適化されたデータアクセス方法により、高速な表示が可能になりました。
システム管理者は必要に応じてデータベースの設置場所マスタを更新してください。

【管理番号の命名規則】
形式：カテゴリーコード+年-連番（4桁）
例：KG2024-0001、JT2024-0001、TM2024-0001...

システムが最適化されたアルゴリズムで自動生成するため、手動での入力は不要です。

【データベーステーブル構成】

■ equipment（設備テーブル）
- id：設備ID（主キー、自動採番）
- management_number：管理番号（ユニーク）
- category_code：カテゴリーコード
- item_code：品目コード
- subcategory_id：サブカテゴリーID
- name：品名
- model_number：型番
- manufacturer：メーカー
- specification：仕様
- cost：購入価格
- purchase_date：購入日
- quantity：数量
- location_code：設置場所コード
- lifespan_years：耐用年数
- is_broken：故障フラグ
- is_available_for_loan：貸出可能フラグ
- usage_deadline：使用期限
- created_at：作成日時
- updated_at：更新日時

■ equipment_lifespan（設備寿命マスタテーブル）
- id：ID（主キー、自動採番）
- category_code：カテゴリーコード
- item_code：品目コード
- lifespan_years：法定耐用年数

■ location（設置場所テーブル）
- id：ID（主キー）
- name：場所名
- parent_id：親場所ID

■ category（カテゴリーテーブル）
- id：ID（主キー）
- code：カテゴリーコード
- name：カテゴリー名

■ subcategory（サブカテゴリーテーブル）
- id：ID（主キー）
- category_id：カテゴリーID（外部キー）
- code：サブカテゴリーコード
- name：サブカテゴリー名

■ useful_life（耐用年数テーブル）
- id：ID（主キー）
- subcategory_id：サブカテゴリーID（外部キー）
- useful_years：耐用年数

【システムの最適化ポイント】

■ データアクセスの最適化
- バッチ処理によるデータ取得の効率化
- キャッシングを活用した高速データアクセス
- インデックスを活用した検索パフォーマンスの向上

■ コード構造の改善
- 責任の明確な分離（サービス層とコントローラー層）
- 共通処理のメソッド抽出による重複コードの削減
- 変数名の明確化による可読性の向上

■ エラー処理の強化
- 日付処理における例外ハンドリングの改善
- データ変換時の堅牢性向上
- ユーザー入力値の検証強化

【トラブルシューティング】

■ アプリケーションが起動しない
- Javaのバージョンを確認（Java 21以上が必要）
- ポート8080が他のアプリケーションで使用されていないか確認
- データベース接続設定を確認

■ データベース接続エラー
- MySQL サーバーが起動しているか確認
- データベース名、ユーザー名、パスワードを確認
- ファイアウォール設定を確認

■ 画面が正しく表示されない
- ブラウザのキャッシュをクリア
- JavaScriptが有効になっているか確認
- ブラウザのコンソールでエラーメッセージを確認

■ 減価償却計算が正しくない
- 設備寿命マスタにカテゴリー・品目の組み合わせが登録されているか確認
- 購入日が正しく入力されているか確認

【セキュリティ注意事項】
- 本システムは社内ネットワークでの使用を想定
- 外部公開する場合は認証機能の追加を推奨
- データベースのパスワードは強固なものを設定
- 定期的なデータバックアップを実施

【システム保守・運用】

■ 定期バックアップ
データベースの定期バックアップを推奨します。
MySQL使用時：mysqldump コマンドを使用

■ ログ確認
アプリケーションログは標準出力に出力されます。
本番環境では適切なログ管理システムの導入を推奨。

■ データメンテナンス
設備寿命マスタの更新：法令改正等に応じて耐用年数を更新
不要データの削除：廃棄済み設備データの定期クリーニング

【お問い合わせ】
システムに関するお問い合わせは、開発チームまでご連絡ください。

設備管理システム開発チーム
Equipment Management Team
バージョン：1.1
作成日：2024年
最終更新日：2024年

===============================================